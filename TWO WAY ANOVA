#Analyze the difference between the means of more than two groups
##data on a quantitative dependent variable at multiple levels of two categorical independent variables

#A two-way ANOVA with interaction tests three null hypotheses at the same time:
##There is no difference in group means at any level of the first independent variable.
##There is no difference in group means at any level of the second independent variable.
##The effect of one independent variable does not depend on the effect of the other independent variable (a.k.a. no interaction effect).

###############
## testa anova 
mod_tw <- aov(Tot_MP ~ Genus * Dimensions, data = DB_MP)
summary(mod_tw)

#Residui 
residui_tw <- residuals(mod_tw)
shapiro.test(residui_tw)  #W = 0.91366, p-value < 2.2e-16

#Omogeneità delle varianze --> p-value > 0.05 = ok ; p-value < 0.05 = varianze non omogenee
bartlett.test(Tot_MP ~ interaction(Genus, Dimensions), data = DB_MP)
leveneTest(Tot_MP ~ Genus * Dimensions, data = DB_MP)  #library(car) #p-value = 1.018e-05 = VARIANZE NON OMOGENEE

#Se uno dei fattori è significativo = test post-hoc come TukeyHSD
TukeyHSD(mod_tw, which = "Genus")
TukeyHSD(mod_tw, which = "Dimensions")
TukeyHSD(mod_tw, which = "Genus:Dimensions")

#Se non è omogeneo/normale: DUNNTEST
dunn_test1 <- dunnTest(Tot_MP ~ Genus, data = DB_MP, method = "holm")
dunn_test2<- dunnTest(Tot_MP ~ Dimensions, data = DB_MP, method = "holm")
dunn_test1
dunn_test2

#Grafico
cld <- cldList(
  comparison = dunn_test$res$Comparison,
  p.value = dunn_test$res$P.adj,
  threshold = 0.05
)
max_val <- max(DB_MP$Tot_MP, na.rm = TRUE)
y_pos <- max_val * 1.05
ggplot(DB_MP, aes(x = Genus, y = Tot_MP)) +
  geom_boxplot(fill = "skyblue") +
  geom_text(data = cld,
            aes(x = Group, y = y_pos, label = Letter),
            inherit.aes = FALSE,
            size = 5) +
  theme_minimal() +
  labs(title = "Tot_MP per Genus con gruppi significativi (Dunn Test)",
       x = "Genus",
       y = "Tot_MP") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
